<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Harmonic Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Self-Contained CSS for Elementor Embedding --- */
        #iulius-sim-container {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-800 */
        }

        #iulius-sim-container *,
        #iulius-sim-container *::before,
        #iulius-sim-container *::after {
            box-sizing: border-box;
        }

        #iulius-sim-container .container {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem; /* p-4 */
        }
        
        @media (min-width: 640px) {
            #iulius-sim-container .container { max-width: 640px; padding: 1.5rem; }
        }
        @media (min-width: 768px) {
            #iulius-sim-container .container { max-width: 768px; }
        }
        @media (min-width: 1024px) {
            #iulius-sim-container .container { max-width: 1024px; padding: 2rem; }
        }
        @media (min-width: 1280px) {
            #iulius-sim-container .container { max-width: 1280px; }
        }

        #iulius-sim-container h1 { font-size: 1.875rem; line-height: 2.25rem; font-weight: 700; color: #111827; }
        #iulius-sim-container h2 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; color: #111827; }
        #iulius-sim-container h3 { font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; color: #1f2937; }

        @media (min-width: 768px) {
            #iulius-sim-container h1 { font-size: 2.25rem; line-height: 2.5rem; }
        }

        #iulius-sim-container .text-center { text-align: center; }
        #iulius-sim-container .text-left { text-align: left; }
        #iulius-sim-container .mb-10 { margin-bottom: 2.5rem; }
        #iulius-sim-container .mb-6 { margin-bottom: 1.5rem; }
        #iulius-sim-container .mb-4 { margin-bottom: 1rem; }
        #iulius-sim-container .mt-1 { margin-top: 0.25rem; }
        #iulius-sim-container .mt-2 { margin-top: 0.5rem; }
        #iulius-sim-container .mt-12 { margin-top: 3rem; }
        
        #iulius-sim-container .space-y-12 > :not([hidden]) ~ :not([hidden]) { margin-top: 3rem; }
        #iulius-sim-container .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
        #iulius-sim-container .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; }
        #iulius-sim-container .space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-left: 1rem; }
        
        #iulius-sim-container .w-full { width: 100%; }
        #iulius-sim-container .w-16 { width: 4rem; }
        #iulius-sim-container .h-2 { height: 0.5rem; }
        #iulius-sim-container .h-5 { height: 1.25rem; }
        #iulius-sim-container .w-5 { width: 1.25rem; }
        #iulius-sim-container .p-6 { padding: 1.5rem; }
        #iulius-sim-container .p-4 { padding: 1rem; }
        #iulius-sim-container .p-2 { padding: 0.5rem; }
        #iulius-sim-container .pb-4 { padding-bottom: 1rem; }
        #iulius-sim-container .pb-2 { padding-bottom: 0.5rem; }
        #iulius-sim-container .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        #iulius-sim-container .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        #iulius-sim-container .px-4 { padding-left: 1rem; padding-right: 1rem; }

        #iulius-sim-container .bg-white { background-color: #ffffff; }
        #iulius-sim-container .bg-gray-50 { background-color: #f9fafb; }
        #iulius-sim-container .bg-gray-200 { background-color: #e5e7eb; }

        #iulius-sim-container .rounded-2xl { border-radius: 1rem; }
        #iulius-sim-container .rounded-xl { border-radius: 0.75rem; }
        #iulius-sim-container .rounded-lg { border-radius: 0.5rem; }
        #iulius-sim-container .rounded { border-radius: 0.25rem; }
        
        #iulius-sim-container .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        #iulius-sim-container .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }

        #iulius-sim-container .border-b { border-bottom-width: 1px; }
        #iulius-sim-container .border-gray-200 { border-color: #e5e7eb; }
        #iulius-sim-container .border-gray-300 { border-color: #d1d5db; }
        
        #iulius-sim-container .grid { display: grid; }
        #iulius-sim-container .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        #iulius-sim-container .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        
        #iulius-sim-container .gap-6 { gap: 1.5rem; }
        #iulius-sim-container .gap-4 { gap: 1rem; }
        #iulius-sim-container .gap-2 { gap: 0.5rem; }
        #iulius-sim-container .gap-x-4 { column-gap: 1rem; }
        #iulius-sim-container .gap-y-3 { row-gap: 0.75rem; }

        @media (min-width: 768px) {
            #iulius-sim-container .md\:p-8 { padding: 2rem; }
            #iulius-sim-container .md\:gap-8 { gap: 2rem; }
        }

        @media (min-width: 1024px) {
            #iulius-sim-container .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            #iulius-sim-container .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            #iulius-sim-container .lg\:col-span-1 { grid-column: span 1 / span 1; }
            #iulius-sim-container .lg\:col-span-2 { grid-column: span 2 / span 2; }
        }

        #iulius-sim-container .self-start { align-self: flex-start; }
        #iulius-sim-container .flex { display: flex; }
        #iulius-sim-container .items-center { align-items: center; }
        #iulius-sim-container .justify-between { justify-content: space-between; }
        #iulius-sim-container .justify-center { justify-content: center; }

        #iulius-sim-container .font-bold { font-weight: 700; }
        #iulius-sim-container .font-semibold { font-weight: 600; }
        #iulius-sim-container .font-medium { font-weight: 500; }

        #iulius-sim-container .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        #iulius-sim-container .text-gray-500 { color: #6b7280; }
        #iulius-sim-container .text-gray-600 { color: #4b5563; }
        #iulius-sim-container .text-gray-700 { color: #374151; }
        #iulius-sim-container .text-gray-800 { color: #1f2937; }
        #iulius-sim-container .text-blue-600 { color: #2563eb; }
        #iulius-sim-container .text-emerald-600 { color: #059669; }
        #iulius-sim-container .text-yellow-500 { color: #f59e0b; }
        #iulius-sim-container .text-white { color: #ffffff; }

        #iulius-sim-container .appearance-none { appearance: none; }
        #iulius-sim-container .cursor-pointer { cursor: pointer; }

        #iulius-sim-container .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer;
            border-radius: 9999px; transition: background-color 0.2s;
        }
        #iulius-sim-container .slider-thumb::-moz-range-thumb {
            width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer;
            border-radius: 9999px; border: none;
            transition: background-color 0.2s;
        }
        #iulius-sim-container .slider-thumb:disabled::-webkit-slider-thumb { background: #9ca3af; }
        #iulius-sim-container .slider-thumb:disabled::-moz-range-thumb { background: #9ca3af; }
        
        #iulius-sim-container .sim-btn {
            width: 100%; font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            color: white;
            border: none;
            cursor: pointer;
        }
        #iulius-sim-container .sim-btn-primary { background-color: #2563eb; }
        #iulius-sim-container .sim-btn-primary:hover { background-color: #1d4ed8; }
        #iulius-sim-container .sim-btn-secondary { background-color: #10b981; }
        #iulius-sim-container .sim-btn-secondary:hover { background-color: #059669; }
        #iulius-sim-container .sim-btn-tertiary { background-color: #374151; }
        #iulius-sim-container .sim-btn-tertiary:hover { background-color: #1f2937; }
        #iulius-sim-container .sim-btn-action { background-color: #f59e0b; }
        #iulius-sim-container .sim-btn-action:hover { background-color: #d97706; }

        #iulius-sim-container .view-mode-btn {
            background-color: #e5e7eb;
            color: #1f2937;
            font-weight: 600;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
        }
        #iulius-sim-container .view-mode-btn:hover { background-color: #d1d5db; }
        #iulius-sim-container .view-mode-btn-active {
            background-color: #3b82f6 !important;
            color: white !important;
        }

        #iulius-sim-container .form-checkbox {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            height: 1.25rem; width: 1.25rem;
            color: #2563eb;
            background-color: #fff;
            border-color: #6b7280;
            border-width: 1px;
            border-radius: 0.25rem;
        }
        #iulius-sim-container .form-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            border-color: transparent;
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }

        #iulius-sim-container canvas { display: block; width: 100%; height: 100%; }

        #iulius-sim-container .canvas-container {
            position: relative; /* Added for logo */
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #f9fafb;
            border-radius: 0.75rem;
            padding: 0.5rem;
        }

        /* --- NEW: Logo on graph CSS --- */
        #iulius-sim-container #iulius-logo-graph {
            position: absolute;
            bottom: 65px; /* From reference app */
            right: 28px;  /* From reference app */
            width: 50px;
            height: auto;
            opacity: 0.2;
            z-index: 10;
            pointer-events: none;
        }

        /* --- NEW: Footer CSS --- */
        #iulius-sim-footer {
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            color: #6b7280; /* text-gray-500 */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            font-family: 'Inter', sans-serif;
        }

    </style>
</head>
<body>
  <div id="iulius-sim-container">
    <div class="container">
        <section id="harmonic-simulator" class="w-full bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="text-left mb-6 pb-4 border-b border-gray-200">
                <h2>String Harmonics Simulator</h2>
                <p class="text-gray-500 mt-1">Visualize how pluck parameters affect a string's harmonic content.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="lg:col-span-1 bg-gray-50 rounded-xl p-6 space-y-6 self-start">
                    <h3>Controls</h3>
                    <div style="display: none;">
                        <label class="flex justify-between font-medium text-gray-700">
                            <span>Fundamental Freq. (f₀)</span>
                            <span id="fundamentalFreqValue" class="font-semibold text-blue-600">82 Hz</span>
                        </label>
                        <input type="range" id="fundamentalFreq" min="50" max="200" value="82" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb mt-2">
                    </div>
                    <div style="display: none;">
                        <label class="flex justify-between font-medium text-gray-700">
                            <span>Scale Length</span>
                            <span id="scaleLengthValue" class="font-semibold text-blue-600">650 mm</span>
                        </label>
                        <input type="range" id="scaleLength" min="500" max="800" value="650" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb mt-2">
                    </div>
                    <div style="display: none;">
                        <label class="flex justify-between font-medium text-gray-700">
                            <span>Pluck Amplitude</span>
                            <span id="pluckAmplitudeValue" class="font-semibold text-blue-600">10 mm</span>
                        </label>
                        <input type="range" id="pluckAmplitude" min="1" max="20" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb mt-2">
                    </div>
                    <div>
                        <label class="flex justify-between font-medium text-gray-700">
                            <span>Pluck Position</span>
                            <span id="pluckPositionValue" class="font-semibold text-blue-600">L / 5.0</span>
                        </label>
                        <input type="range" id="pluckPosition" min="10" max="990" value="222" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb mt-2">
                    </div>
                    <div>
                        <label class="flex justify-between font-medium text-gray-700">
                            <span>Number of Harmonics</span>
                            <span id="numHarmonicsValue" class="font-semibold text-blue-600">5</span>
                        </label>
                        <input type="range" id="numHarmonics" min="1" max="20" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb mt-2">
                    </div>
                </div>
                <div class="lg:col-span-2 grid grid-cols-1 gap-6">
                    <div class="canvas-container">
                        <canvas id="harmonicSimCanvas"></canvas>
                        <img id="iulius-logo-graph" src="https://www.iuliusguitars.com/wp-content/uploads/2025/10/IuliusBlack.png" alt="Iulius Guitars Logo">
                    </div>
                    <div class="canvas-container">
                        <canvas id="spectrumCanvas"></canvas>
                        <img id="iulius-logo-graph" src="https://www.iuliusguitars.com/wp-content/uploads/2025/10/IuliusBlack.png" alt="Iulius Guitars Logo">
                    </div>
                </div>
            </div>
        </section>

        <div id="iulius-sim-footer">
            © Iulius Guitars – Giuliano Nicoletti. These tools are shared for your personal growth. If you'd like to share them, just ask first.
        </div>

    </div> </div> <script>
    // --- JavaScript remains unchanged ---
    (() => {
        // --- Universal resize handler ---
        const allCanvases = document.querySelectorAll('canvas');
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                allCanvases.forEach(canvas => {
                    const event = new CustomEvent('redrawCanvas');
                    canvas.dispatchEvent(event);
                });
            }, 100);
        });

        // --- Utility to size a canvas and its container ---
        function sizeCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const parent = canvas.parentElement;
            const rect = parent.getBoundingClientRect();
            
            if (rect.width <= 0 || rect.height <= 0) {
                return { width: 0, height: 0 };
            }
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            const ctx = canvas.getContext('2d');
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // Use setTransform for robustness
            return { width: rect.width, height: rect.height };
        }

        // ===================================================================
        // ==                                                               ==
        // ==                   INITIALIZATION FUNCTIONS                    ==
        // ==                                                               ==
        // ===================================================================

        function initHarmonicSim() {
            const section = document.getElementById('harmonic-simulator');
            if (!section) return;
            
            const simCanvas = section.querySelector('#harmonicSimCanvas');
            const spectrumCanvas = section.querySelector('#spectrumCanvas');
            const simCtx = simCanvas.getContext('2d');
            const spectrumCtx = spectrumCanvas.getContext('2d');
            const fundamentalFreqSlider = section.querySelector('#fundamentalFreq');
            const scaleLengthSlider = section.querySelector('#scaleLength');
            const pluckAmplitudeSlider = section.querySelector('#pluckAmplitude');
            const pluckPositionSlider = section.querySelector('#pluckPosition');
            const numHarmonicsSlider = section.querySelector('#numHarmonics');
            const fundamentalFreqValue = section.querySelector('#fundamentalFreqValue');
            const scaleLengthValue = section.querySelector('#scaleLengthValue');
            const pluckAmplitudeValue = section.querySelector('#pluckAmplitudeValue');
            const pluckPositionValue = section.querySelector('#pluckPositionValue');
            const numHarmonicsValue = section.querySelector('#numHarmonicsValue');

            const HARMONIC_COLORS = ['#3b82f6', '#ef4444', '#10b981', '#a855f7', '#eab308', '#f97316', '#14b8a6', '#6366f1', '#d946ef', '#0ea5e9', '#84cc16', '#f43f5e', '#78716c', '#06b6d4', '#4ade80', '#c084fc', '#fbbf24', '#fb923c', '#2dd4bf', '#818cf8'];
            
            // **** MODIFIED THIS LINE ****
            let state = { f0: 82, L: 650, h: 10, xp_ratio: 0.222, N: 5 }; // MODIFIED: h default 8 -> 10, xp_ratio 0.2 -> 0.222
            
            let harmonicAmplitudes = [];

            function drawAll() {
                calculateHarmonics();
                drawSimulation();
                drawSpectrum();
            }
            
            function calculateHarmonics() {
                harmonicAmplitudes = [];
                const { L, h, xp_ratio, N } = state;
                const xp = L * xp_ratio;
                for (let n = 1; n <= N; n++) {
                    const amp_num = 2 * h * L ** 2;
                    const amp_den = (n ** 2) * (Math.PI ** 2) * xp * (L - xp);
                    const sine_term = Math.sin(n * Math.PI * xp / L);
                    let Bn = (amp_den === 0) ? 0 : (amp_num / amp_den) * sine_term;
                    if (!isFinite(Bn) || Math.abs(Bn) < 1e-9) Bn = 0;
                    harmonicAmplitudes.push({n, amp: Bn});
                }
            }

            function drawSimulation() {
                const { width, height } = sizeCanvas(simCanvas);
                if(width === 0) return;
                simCtx.clearRect(0, 0, width, height);
                const { L, h, xp_ratio } = state;
                const xp = L * xp_ratio;
                const padding = { top: 40, right: 20, bottom: 40, left: 50 };
                const plotWidth = width - padding.left - padding.right;
                const plotHeight = height - padding.top - padding.bottom;
                const y_max = 10; // MODIFIED: Was h * 1.5, now fixed to 10mm
                const mapX = (x) => padding.left + (x / L) * plotWidth;
                const mapY = (y) => (height - padding.bottom) - (y / (2 * y_max)) * plotHeight - plotHeight / 2;
                drawGridAndAxes(simCtx, width, height, padding, mapX, mapY, L, y_max);
                simCtx.strokeStyle = '#111827';
                simCtx.lineWidth = 2.5;
                simCtx.beginPath();
                simCtx.moveTo(mapX(0), mapY(0));
                simCtx.lineTo(mapX(xp), mapY(h));
                simCtx.lineTo(mapX(L), mapY(0));
                simCtx.stroke();
                const x_points = Array.from({length: Math.floor(plotWidth)}, (_, i) => (i / (plotWidth-1)) * L);
                const clip_boundary = y_max * 1.05;
                harmonicAmplitudes.forEach(({n, amp}) => {
                    if (amp === 0) return;
                    simCtx.strokeStyle = HARMONIC_COLORS[(n-1) % HARMONIC_COLORS.length];
                    simCtx.lineWidth = 2;
                    simCtx.beginPath();
                    simCtx.moveTo(mapX(0), mapY(0));
                    x_points.forEach(x => {
                        let y = amp * Math.sin(n * Math.PI * x / L);
                        if (y > clip_boundary) y = clip_boundary;
                        if (y < -clip_boundary) y = -clip_boundary;
                        simCtx.lineTo(mapX(x), mapY(y));
                    });
                    simCtx.stroke();
                });

                // --- START: Legend Drawing (NEW CODE) ---
                
                // Helper for harmonic names
                function getHarmonicName(n) {
                    if (n === 1) return 'Fundamental';
                    if (n === 2) return 'Second Harmonic';
                    if (n === 3) return 'Third Harmonic';
                    
                    // Use 'th' for 11, 12, 13
                    if (n % 100 >= 11 && n % 100 <= 13) {
                        return `${n}th Harmonic`;
                    }
                    
                    // Use ordinal for others
                    switch (n % 10) {
                        case 1: return `${n}st Harmonic`;
                        case 2: return `${n}nd Harmonic`;
                        case 3: return `${n}rd Harmonic`;
                        default: return `${n}th Harmonic`;
                    }
                }

                const legendItems = [];
                legendItems.push({ label: 'Plucked String', color: '#111827' });

                for (let n = 1; n <= state.N; n++) {
                    legendItems.push({
                        label: getHarmonicName(n),
                        color: HARMONIC_COLORS[(n-1) % HARMONIC_COLORS.length]
                    });
                }

                const legendItemHeight = 20;
                const legendBoxSize = 12;
                const totalLegendHeight = legendItems.length * legendItemHeight;
                const legendX = padding.left + 20; // A bit more padding
                // Position legend at bottom-left, as in the reference image
                let legendY = (height - padding.bottom) - totalLegendHeight; 

                simCtx.font = '500 12px Inter';
                simCtx.textAlign = 'left';
                simCtx.textBaseline = 'middle';

                legendItems.forEach(item => {
                    simCtx.fillStyle = item.color;
                    simCtx.fillRect(legendX, legendY - legendBoxSize / 2, legendBoxSize, legendBoxSize);
                    
                    simCtx.fillStyle = '#1f2937'; // text-gray-800
                    simCtx.fillText(item.label, legendX + legendBoxSize + 8, legendY);
                    
                    legendY += legendItemHeight;
                });
                // --- END: Legend Drawing (NEW CODE) ---
            }

            function drawSpectrum() {
                const { width, height } = sizeCanvas(spectrumCanvas);
                 if(width === 0) return;
                spectrumCtx.clearRect(0, 0, width, height);
                const { N, f0 } = state;
                const padding = { top: 40, right: 20, bottom: 40, left: 50 };
                const plotWidth = width - padding.left - padding.right;
                const plotHeight = height - padding.top - padding.bottom;
                const finiteAmps = harmonicAmplitudes.map(h => Math.abs(h.amp)).filter(isFinite);
                const maxPeakAmp = finiteAmps.length > 0 ? Math.max(0.0001, ...finiteAmps) : 0.0001;
                const minDB = -50, maxDB = 0;
                const maxFreq = (N + 0.5) * f0;
                const mapX = (freq) => padding.left + (freq / maxFreq) * plotWidth;
                const mapY = (db) => (height - padding.bottom) - ((db - minDB) / (maxDB - minDB)) * plotHeight;
                drawSpectrumGridAndAxes(spectrumCtx, width, height, padding, mapX, mapY, maxFreq, minDB, maxDB);
                const lorentzian = (x, center, amp, gamma) => (amp === 0) ? 0 : Math.abs(amp) * (gamma**2 / ((x - center)**2 + gamma**2));
                const peakWidth = f0 / 25;
                spectrumCtx.beginPath();
                const plotWidthPixels = width - padding.left - padding.right;
                const pathPoints = [];
                const powerNoiseFloor = (maxPeakAmp * (10**(minDB/20))) ** 2; 
                for (let i = 0; i <= plotWidthPixels; i++) {
                    const freq = (i / plotWidthPixels) * maxFreq;
                    let totalPower = powerNoiseFloor;
                    harmonicAmplitudes.forEach(({ n, amp }) => {
                        if (isFinite(amp)) totalPower += lorentzian(freq, n * f0, amp, peakWidth) ** 2;
                    });
                    const totalRmsAmp = Math.sqrt(totalPower);
                    const ampDB = totalRmsAmp > 0 ? 20 * Math.log10(totalRmsAmp / maxPeakAmp) : minDB;
                    const y = mapY(Math.max(ampDB, minDB));
                    const x = padding.left + i;
                    if (i === 0) spectrumCtx.moveTo(x, y); else spectrumCtx.lineTo(x, y);
                    pathPoints.push({x, y});
                }
                spectrumCtx.strokeStyle = '#0284c7';
                spectrumCtx.lineWidth = 1.5;
                spectrumCtx.stroke();
                if (pathPoints.length > 0) {
                    spectrumCtx.lineTo(pathPoints[pathPoints.length - 1].x, height - padding.bottom);
                    spectrumCtx.lineTo(padding.left, height - padding.bottom);
                    spectrumCtx.closePath();
                    spectrumCtx.fillStyle = 'rgba(2, 132, 199, 0.1)';
                    spectrumCtx.fill();
                }
            }
            
            function drawGridAndAxes(ctx, w, h, p, mapX, mapY, L, y_max) {
                ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
                const gridStep = y_max > 5 ? Math.ceil(y_max / 4 / 5) * 5 : 2;
                for(let i = -Math.floor(y_max); i <= Math.floor(y_max); i += gridStep) {
                    if(i !== 0 && y_max > 0) {
                        const y_c = mapY(i); ctx.beginPath(); ctx.moveTo(p.left, y_c); ctx.lineTo(w - p.right, y_c); ctx.stroke();
                    }
                }
                ctx.strokeStyle = '#9ca3af';
                ctx.beginPath(); ctx.moveTo(p.left, mapY(0)); ctx.lineTo(w - p.right, mapY(0)); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(p.left, p.top); ctx.lineTo(p.left, h - p.bottom); ctx.stroke();
                ctx.fillStyle = '#4b5563'; ctx.font = '500 12px Inter'; ctx.textAlign = 'center';
                ctx.fillText('Length (mm)', p.left + (w - p.left - p.right) / 2, h - 10);
                ctx.save(); ctx.translate(15, h / 2); ctx.rotate(-Math.PI / 2); ctx.fillText('Displacement (mm)', 0, 0); ctx.restore();
                for (let i = 0; i <= 5; i++) { const pos = L * i / 5; ctx.fillText(pos.toFixed(0), mapX(pos), mapY(0) + 15); }
                ctx.textAlign = 'right';
                if (y_max > 0) {
                    for(let i = -Math.floor(y_max); i <= Math.floor(y_max); i += gridStep) {
                        if(i !== 0) ctx.fillText(i, p.left - 8, mapY(i)+4);
                    }
                }
            }

            function drawSpectrumGridAndAxes(ctx, w, h, p, mapX, mapY, maxFreq, minDB, maxDB) {
                ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
                for(let db = minDB + 10; db < maxDB; db += 10) {
                    const y = mapY(db); ctx.beginPath(); ctx.moveTo(p.left, y); ctx.lineTo(w - p.right, y); ctx.stroke();
                }
                ctx.strokeStyle = '#9ca3af';
                ctx.beginPath(); ctx.moveTo(p.left, h - p.bottom); ctx.lineTo(w - p.right, h - p.bottom); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(p.left, p.top); ctx.lineTo(p.left, h - p.bottom); ctx.stroke();
                ctx.fillStyle = '#4b5563'; ctx.font = '500 12px Inter'; ctx.textAlign = 'center';
                ctx.fillText('Frequency (Hz)', p.left + (w - p.left - p.right) / 2, h - 10);
                ctx.save(); ctx.translate(15, h / 2); ctx.rotate(-Math.PI / 2); ctx.fillText('Amplitude (dB)', 0, 0); ctx.restore();
                for (let i = 1; i <= state.N; i++) {
                  const freq = i * state.f0; // <-- THIS WAS THE FIX
                  if (mapX(freq) < w - p.right * 1.5) ctx.fillText(freq.toFixed(0), mapX(freq), h - p.bottom + 15);
                }
                 ctx.textAlign = 'right';
                 for(let db = minDB; db <= maxDB; db += 10) ctx.fillText(db, p.left - 8, mapY(db)+4);
            }
            
            function updateStateAndDraw(updater) { updater(); drawAll(); }
            
            fundamentalFreqSlider.addEventListener('input', e => updateStateAndDraw(() => { state.f0 = Number(e.target.value); fundamentalFreqValue.textContent = `${state.f0} Hz`; }));
            scaleLengthSlider.addEventListener('input', e => updateStateAndDra(() => { state.L = Number(e.target.value); scaleLengthValue.textContent = `${state.L} mm`; }));
            pluckAmplitudeSlider.addEventListener('input', e => updateStateAndDraw(() => { state.h = Number(e.target.value); pluckAmplitudeValue.textContent = `${state.h} mm`; }));
            pluckPositionSlider.addEventListener('input', e => updateStateAndDraw(() => { state.xp_ratio = Number(e.target.value) / 1000; pluckPositionValue.textContent = `L / ${(1 / state.xp_ratio).toFixed(1)}`; }));
            numHarmonicsSlider.addEventListener('input', e => updateStateAndDraw(() => { state.N = Number(e.target.value); numHarmonicsValue.textContent = state.N; }));
            
            fundamentalFreqValue.textContent = `${state.f0} Hz`;
            scaleLengthValue.textContent = `${state.L} mm`;
            pluckAmplitudeValue.textContent = `${state.h} mm`;
            pluckPositionValue.textContent = `L / ${(1 / state.xp_ratio).toFixed(1)}`;
            numHarmonicsValue.textContent = state.N;
            
            simCanvas.addEventListener('redrawCanvas', drawAll);
            spectrumCanvas.addEventListener('redrawCanvas', drawAll);
            
            drawAll();
        }

        // Removed initImpedanceSim and initStandingWaveSim as they are not in this file's HTML

        // --- Master Initializer ---
        function initializeAll() {
            // Only initialize the harmonic simulator
            initHarmonicSim();
            // Trigger a resize event to make sure canvases are sized correctly on load
            window.dispatchEvent(new Event('resize'));
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAll);
        } else {
            initializeAll();
        }
        
    })();
    </script>
</body>
</html>